# This is an OPTIONAL configuration for running Celery workers separately from the web server
# This helps memory management by separating concerns
# Only use this if you need to run background tasks

services:
  - type: background_worker
    name: Bunoraa-Celery-Worker
    runtime: python
    buildCommand: "./build.sh"
    startCommand: "celery -A core worker -n worker@%h --pool=solo -l warning --max-tasks-per-child=100"
    envVars:
      - key: ENVIRONMENT
        value: "production"
      - key: DJANGO_SETTINGS_MODULE
        value: "core.settings.production"
      - key: ML_ENABLED
        value: "false"
      - key: PRERENDER_ENABLED
        value: "false"
      - key: LIBRETRANSLATE_URL
        value: "http://bunoraa-libretranslate:5000"
      - key: LIBRETRANSLATE_API_KEY
        value: ""
      - key: DATABASE_URL
        fromDatabase:
          name: bunoraa_db
          property: connectionString
      - key: SECRET_KEY
        sync: false
      - key: USE_S3
        value: "True"
      - key: AWS_ACCESS_KEY_ID
        sync: false
      - key: AWS_SECRET_ACCESS_KEY
        sync: false
      - key: AWS_STORAGE_BUCKET_NAME
        value: "bunoraa"
      - key: AWS_S3_REGION_NAME
        value: "us-east-1"
      - key: AWS_S3_ENDPOINT_URL
        value: "https://<R2_ACCOUNT_ID>.r2.cloudflarestorage.com"
      - key: AWS_S3_CUSTOM_DOMAIN
        value: "media.bunoraa.com"
      - key: AWS_DEFAULT_ACL
        value: "None"
      - key: AWS_S3_CACHE_CONTROL
        value: "max-age=86400"
      - key: MEDIA_URL
        value: "https://media.bunoraa.com/"
      - key: REDIS_URL
        fromService:
          type: redis
          name: bunoraa-redis
          property: connectionString
      - key: CHANNEL_LAYERS_REDIS_URL
        fromService:
          type: redis
          name: bunoraa-redis
          property: connectionString
      - key: CELERY_BROKER_URL
        fromService:
          type: redis
          name: bunoraa-redis
          property: connectionString
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: redis
          name: bunoraa-redis
          property: connectionString
      - key: DEBUG
        value: false
    plan: free
